SELECT
  uid,
  country,
  app_version,
  device_category,
  mobile_brand_name,
  mobile_model_name,
  mobile_marketing_name,
  event_name,
  platform,
  event_timestamp_ms,
  event_timestamp,
  user_creation_timestamp,
  days_retained,
  ltv_revenue,
  up_first_app_version,
  up_gems,
  up_coins,
  up_track_level,
  up_first_open_time,
  up_iapPurchasedCount,
  up_track_level_backend,
  up_rank,
  up_user_property_rank,
  ep_boss,
  ep_chest_slots_open,
  ep_coins,
  ep_cup_id,
  ep_current_level_air_control,
  ep_current_level_center_of_mass,
  ep_current_level_downforce,
  ep_current_level_engine,
  ep_current_level_fuel_tank,
  ep_current_level_gearbox,
  ep_current_level_grip,
  ep_current_level_power_distribution,
  ep_current_level_rollcage,
  ep_current_level_springs,
  ep_current_level_stability,
  ep_current_level_turbo,
  ep_event,
  ep_firebase_error,
  ep_firebase_event_origin,
  ep_firebase_screen_class,
  ep_firebase_screen_id,
  ep_gems,
  ep_open_special,
  ep_points_1,
  ep_points_2,
  ep_points_3,
  ep_points_4,
  ep_points_earned,
  ep_points_max,
  ep_position,
  ep_rank_delta,
  ep_session_coins,
  ep_session_gems,
  ep_session_time,
  ep_special,
  ep_total_coins,
  ep_total_gems,
  ep_total_play_time,
  ep_total_time,
  ep_vehicle,
  ep_wc_rank,
  ep_wc_min_rank,
  IFNULL(gold_reward,
    (CASE
        WHEN (gold_reward IS NULL AND a.ep_position = '1') THEN 350
        WHEN (gold_reward IS NULL
        AND a.ep_position = '2') THEN 150
        WHEN (gold_reward IS NULL AND a.ep_position = '3') THEN 50
        WHEN (gold_reward IS NULL
        AND a.ep_position = '4') THEN 25 END)) AS ep_cup_gold_reward
FROM (
  SELECT
    uid,
    country,
    app_version,
    device_category,
    mobile_brand_name,
    mobile_model_name,
    mobile_marketing_name,
    event_name,
    platform,
    event_timestamp_ms,
    event_timestamp,
    user_creation_timestamp,
    days_retained,
    ltv_revenue,
    up_first_app_version,
    up_gems,
    up_coins,
    up_track_level,
    up_first_open_time,
    up_iapPurchasedCount,
    up_track_level_backend,
    up_rank,
    up_user_property_rank,
    ep_boss,
    ep_chest_slots_open,
    ep_coins,
    ep_cup_id,
    ep_current_level_air_control,
    ep_current_level_center_of_mass,
    ep_current_level_downforce,
    ep_current_level_engine,
    ep_current_level_fuel_tank,
    ep_current_level_gearbox,
    ep_current_level_grip,
    ep_current_level_power_distribution,
    ep_current_level_rollcage,
    ep_current_level_springs,
    ep_current_level_stability,
    ep_current_level_turbo,
    ep_event,
    ep_firebase_error,
    ep_firebase_event_origin,
    ep_firebase_screen_class,
    ep_firebase_screen_id,
    ep_gems,
    ep_open_special,
    ep_points_1,
    ep_points_2,
    ep_points_3,
    ep_points_4,
    ep_points_earned,
    ep_points_max,
    ep_position,
    ep_rank_delta,
    ep_session_coins,
    ep_session_gems,
    ep_session_time,
    ep_special,
    ep_total_coins,
    ep_total_gems,
    ep_total_play_time,
    ep_total_time,
    ep_vehicle,
    ep_wc_rank,
    INTEGER(FLOOR(INTEGER(ep_wc_rank)/1000)) AS ep_wc_min_rank
  FROM
    [hill-climb-racing-2-67064304:materialized_views.events_flat_20170702]
  WHERE
    (event_name = 'cup_finished')
    AND uid NOT IN (
    SELECT
      uid
    FROM
      [hill-climb-racing-2-67064304:materialized_views.lifetime_cheaters_hackers])) AS a
LEFT OUTER JOIN
  [hill-climb-racing-2-67064304:test_data.lkp_reward] AS b
ON
  a.ep_wc_min_rank=b.rank
  AND a.ep_position = b.position